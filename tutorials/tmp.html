<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pablo Winant">

<title>Introduction to Computational Economics - Discrete Dynamic Programming</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      Introduction to Computational Economics
      </li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Introduction to Computational Economics</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Slides</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/session_1/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/session_2/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convergence of Sequences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/session_3/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/session_6/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/session_7/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discrete Dynamic Programming</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/1_1_Julia_Basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorial: Julia Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/2_solow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convergence: Solow Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/3_Optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/6_automatic_differentiation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation and Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/7_discrete_dynamic_programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discrete Dynamic Programming</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Pushups</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pushups/1_epidemiology.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Epidemiology Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pushups/2_Optimization_pushups.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimization Pushups</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#markov-chains" id="toc-markov-chains" class="nav-link active" data-scroll-target="#markov-chains">Markov Chains</a></li>
  <li><a href="#basic-asset-pricing-model" id="toc-basic-asset-pricing-model" class="nav-link" data-scroll-target="#basic-asset-pricing-model">Basic Asset Pricing model</a></li>
  <li><a href="#asset-replacement-from-compecon" id="toc-asset-replacement-from-compecon" class="nav-link" data-scroll-target="#asset-replacement-from-compecon">Asset replacement (from Compecon)</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="tmp.out.ipynb" download="tmp.out.ipynb"><i class="bi bi-journal-code"></i>Jupyter</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Discrete Dynamic Programming</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Pablo Winant </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="markov-chains" class="level2">
<h2 class="anchored" data-anchor-id="markov-chains">Markov Chains</h2>
<p>A worker’s employment dynamics obey the stochastic matrix</p>
<p><span class="math display">\[P = \begin{bmatrix}
1-\alpha &amp; \alpha \\
\beta &amp; 1-\beta
\end{bmatrix}\]</span></p>
<p><span class="math display">\[P = \begin{bmatrix}
1-\alpha &amp; ... \\
\beta &amp; ...
\end{bmatrix}\]</span></p>
<p>with <span class="math inline">\(\alpha\in(0,1)\)</span> and <span class="math inline">\(\beta\in (0,1)\)</span>. First line corresponds to employment, second line to unemployment.</p>
<p><strong>Which is the stationary equilibrium? (choose any value for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>)</strong></p>
<p><strong>In the long run, what will the the fraction <span class="math inline">\(p\)</span> of time spent unemployed? (Denote by <span class="math inline">\(X_m\)</span> the fraction of dates were one is unemployed)</strong></p>
<p><strong>Illustrate this convergence by generating a simulated series of length 10000 starting at <span class="math inline">\(X_0=1\)</span>. Plot <span class="math inline">\(X_m-p\)</span> against <span class="math inline">\(m\)</span>. (Take <span class="math inline">\(\alpha=\beta=0.1\)</span>).</strong></p>
</section>
<section id="basic-asset-pricing-model" class="level2">
<h2 class="anchored" data-anchor-id="basic-asset-pricing-model">Basic Asset Pricing model</h2>
<p>A financial asset yields dividend <span class="math inline">\((x_t)\)</span>, which follows an AR1. It is evaluated using the stochastic discount factor: <span class="math inline">\(\rho_{0,t} = \beta^t \exp(y_t)\)</span> where <span class="math inline">\(\beta&lt;1\)</span> and <span class="math inline">\(y_t\)</span> is an <span class="math inline">\(AR1\)</span>. The price of the asset is given by <span class="math inline">\(p_0 = \sum_{t\geq 0} \rho_{0,t} U(x_t)\)</span> where <span class="math inline">\(U(u)=\exp(u)^{0.5}/{0.5}\)</span>. Our goal is to find the pricing function <span class="math inline">\(p(x,y)\)</span>, which yields the price of the asset in any state.</p>
<p><strong>Write down the recursive equation which must be satisfied by <span class="math inline">\(p\)</span>.</strong></p>
<p><span class="math display">\[p_t = U(x_t) + \beta E_t \left[ \frac{e^{y_{t+1}}}{e^{y_t}} p_{t+1} \right]\]</span></p>
<p><strong>Compute the ergodic distribution of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>.</strong></p>
<p><strong>Discretize processes <span class="math inline">\((x_t)\)</span> and <span class="math inline">\((y_t)\)</span> using 2 states each. How would you represent the unknown <span class="math inline">\(p()\)</span>?</strong></p>
<p><strong>Solve for <span class="math inline">\(p()\)</span> using successive approximations</strong></p>
<p><strong>Solve for <span class="math inline">\(p()\)</span> by solving a linear system (homework)</strong></p>
</section>
<section id="asset-replacement-from-compecon" class="level2">
<h2 class="anchored" data-anchor-id="asset-replacement-from-compecon">Asset replacement (from Compecon)</h2>
<p>At the beginning of each year, a manufacturer must decide whether to continue to operate an aging physical asset or replace it with a new one.</p>
<p>An asset that is <span class="math inline">\(a\)</span> years old yields a profit contribution <span class="math inline">\(p(a)\)</span> up to <span class="math inline">\(n\)</span> years, at which point, the asset becomes unsafe and must be replaced by law.</p>
<p>The cost of a new asset is <span class="math inline">\(c\)</span>. What replacement policy maximizes profits?</p>
<p>Calibration: profit <span class="math inline">\(p(a)=50-2.5a-2.5a^2\)</span>. Maximum asset age: 5 years. Asset replacement cost: 75, annual discount factor <span class="math inline">\(\delta=0.9\)</span>.</p>
<div id="cell-21" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">p</span>(a) <span class="op">=</span> <span class="fl">50</span><span class="op">-</span><span class="fl">2.5</span>a<span class="op">-</span><span class="fl">2.5</span>a<span class="op">^</span><span class="fl">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>p (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( [<span class="fu">p</span>(i) for i<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="600" height="400" viewbox="0 0 2400 1600">
<defs>
  <clippath id="clip710">
    <rect x="0" y="0" width="2400" height="1600"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip710)" d="M0 1600 L2400 1600 L2400 0 L0 0  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip711">
    <rect x="480" y="0" width="1681" height="1600"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip710)" d="M178.867 1486.45 L2352.76 1486.45 L2352.76 47.2441 L178.867 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip712">
    <rect x="178" y="47" width="2175" height="1440"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="240.392,1486.45 240.392,47.2441 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="650.56,1486.45 650.56,47.2441 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1060.73,1486.45 1060.73,47.2441 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1470.9,1486.45 1470.9,47.2441 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1881.06,1486.45 1881.06,47.2441 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2291.23,1486.45 2291.23,47.2441 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="178.867,1486.45 2352.76,1486.45 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="240.392,1486.45 240.392,1467.55 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="650.56,1486.45 650.56,1467.55 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1060.73,1486.45 1060.73,1467.55 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1470.9,1486.45 1470.9,1467.55 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1881.06,1486.45 1881.06,1467.55 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2291.23,1486.45 2291.23,1467.55 "></polyline>
<path clip-path="url(#clip710)" d="M230.774 1544.91 L238.413 1544.91 L238.413 1518.55 L230.103 1520.21 L230.103 1515.95 L238.366 1514.29 L243.042 1514.29 L243.042 1544.91 L250.681 1544.91 L250.681 1548.85 L230.774 1548.85 L230.774 1544.91 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M645.212 1544.91 L661.532 1544.91 L661.532 1548.85 L639.587 1548.85 L639.587 1544.91 Q642.249 1542.16 646.833 1537.53 Q651.439 1532.88 652.62 1531.53 Q654.865 1529.01 655.745 1527.27 Q656.648 1525.51 656.648 1523.82 Q656.648 1521.07 654.703 1519.33 Q652.782 1517.6 649.68 1517.6 Q647.481 1517.6 645.027 1518.36 Q642.597 1519.13 639.819 1520.68 L639.819 1515.95 Q642.643 1514.82 645.097 1514.24 Q647.55 1513.66 649.587 1513.66 Q654.958 1513.66 658.152 1516.35 Q661.347 1519.03 661.347 1523.52 Q661.347 1525.65 660.536 1527.57 Q659.749 1529.47 657.643 1532.07 Q657.064 1532.74 653.962 1535.95 Q650.861 1539.15 645.212 1544.91 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M1064.98 1530.21 Q1068.33 1530.93 1070.21 1533.2 Q1072.1 1535.47 1072.1 1538.8 Q1072.1 1543.92 1068.59 1546.72 Q1065.07 1549.52 1058.59 1549.52 Q1056.41 1549.52 1054.1 1549.08 Q1051.8 1548.66 1049.35 1547.81 L1049.35 1543.29 Q1051.29 1544.43 1053.61 1545.01 Q1055.92 1545.58 1058.45 1545.58 Q1062.85 1545.58 1065.14 1543.85 Q1067.45 1542.11 1067.45 1538.8 Q1067.45 1535.75 1065.3 1534.03 Q1063.17 1532.3 1059.35 1532.3 L1055.32 1532.3 L1055.32 1528.45 L1059.54 1528.45 Q1062.98 1528.45 1064.81 1527.09 Q1066.64 1525.7 1066.64 1523.11 Q1066.64 1520.45 1064.74 1519.03 Q1062.87 1517.6 1059.35 1517.6 Q1057.43 1517.6 1055.23 1518.01 Q1053.03 1518.43 1050.39 1519.31 L1050.39 1515.14 Q1053.05 1514.4 1055.37 1514.03 Q1057.71 1513.66 1059.77 1513.66 Q1065.09 1513.66 1068.19 1516.09 Q1071.29 1518.5 1071.29 1522.62 Q1071.29 1525.49 1069.65 1527.48 Q1068.01 1529.45 1064.98 1530.21 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M1473.9 1518.36 L1462.1 1536.81 L1473.9 1536.81 L1473.9 1518.36 M1472.68 1514.29 L1478.56 1514.29 L1478.56 1536.81 L1483.49 1536.81 L1483.49 1540.7 L1478.56 1540.7 L1478.56 1548.85 L1473.9 1548.85 L1473.9 1540.7 L1458.3 1540.7 L1458.3 1536.19 L1472.68 1514.29 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M1871.34 1514.29 L1889.7 1514.29 L1889.7 1518.22 L1875.62 1518.22 L1875.62 1526.7 Q1876.64 1526.35 1877.66 1526.19 Q1878.68 1526 1879.7 1526 Q1885.48 1526 1888.86 1529.17 Q1892.24 1532.34 1892.24 1537.76 Q1892.24 1543.34 1888.77 1546.44 Q1885.3 1549.52 1878.98 1549.52 Q1876.8 1549.52 1874.54 1549.15 Q1872.29 1548.78 1869.88 1548.04 L1869.88 1543.34 Q1871.97 1544.47 1874.19 1545.03 Q1876.41 1545.58 1878.89 1545.58 Q1882.89 1545.58 1885.23 1543.48 Q1887.57 1541.37 1887.57 1537.76 Q1887.57 1534.15 1885.23 1532.04 Q1882.89 1529.94 1878.89 1529.94 Q1877.01 1529.94 1875.14 1530.35 Q1873.29 1530.77 1871.34 1531.65 L1871.34 1514.29 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M2291.64 1529.7 Q2288.49 1529.7 2286.64 1531.86 Q2284.81 1534.01 2284.81 1537.76 Q2284.81 1541.49 2286.64 1543.66 Q2288.49 1545.82 2291.64 1545.82 Q2294.78 1545.82 2296.61 1543.66 Q2298.46 1541.49 2298.46 1537.76 Q2298.46 1534.01 2296.61 1531.86 Q2294.78 1529.7 2291.64 1529.7 M2300.92 1515.05 L2300.92 1519.31 Q2299.16 1518.48 2297.35 1518.04 Q2295.57 1517.6 2293.81 1517.6 Q2289.18 1517.6 2286.73 1520.72 Q2284.3 1523.85 2283.95 1530.17 Q2285.32 1528.15 2287.38 1527.09 Q2289.44 1526 2291.91 1526 Q2297.12 1526 2300.13 1529.17 Q2303.16 1532.32 2303.16 1537.76 Q2303.16 1543.08 2300.02 1546.3 Q2296.87 1549.52 2291.64 1549.52 Q2285.64 1549.52 2282.47 1544.94 Q2279.3 1540.33 2279.3 1531.6 Q2279.3 1523.41 2283.19 1518.55 Q2287.08 1513.66 2293.63 1513.66 Q2295.39 1513.66 2297.17 1514.01 Q2298.97 1514.36 2300.92 1515.05 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="178.867,1355.2 2352.76,1355.2 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="178.867,993.136 2352.76,993.136 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="178.867,631.072 2352.76,631.072 "></polyline>
<polyline clip-path="url(#clip712)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="178.867,269.008 2352.76,269.008 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="178.867,1486.45 178.867,47.2441 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="178.867,1355.2 197.764,1355.2 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="178.867,993.136 197.764,993.136 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="178.867,631.072 197.764,631.072 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="178.867,269.008 197.764,269.008 "></polyline>
<path clip-path="url(#clip710)" d="M50.9921 1355.65 L80.6679 1355.65 L80.6679 1359.59 L50.9921 1359.59 L50.9921 1355.65 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M94.7882 1368.54 L111.108 1368.54 L111.108 1372.48 L89.1632 1372.48 L89.1632 1368.54 Q91.8252 1365.79 96.4085 1361.16 Q101.015 1356.51 102.196 1355.17 Q104.441 1352.64 105.321 1350.91 Q106.223 1349.15 106.223 1347.46 Q106.223 1344.7 104.279 1342.97 Q102.358 1341.23 99.2558 1341.23 Q97.0567 1341.23 94.603 1341.99 Q92.1725 1342.76 89.3947 1344.31 L89.3947 1339.59 Q92.2188 1338.45 94.6724 1337.87 Q97.1261 1337.29 99.1632 1337.29 Q104.534 1337.29 107.728 1339.98 Q110.922 1342.67 110.922 1347.16 Q110.922 1349.29 110.112 1351.21 Q109.325 1353.1 107.219 1355.7 Q106.64 1356.37 103.538 1359.59 Q100.436 1362.78 94.7882 1368.54 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M130.922 1341 Q127.311 1341 125.482 1344.56 Q123.677 1348.1 123.677 1355.23 Q123.677 1362.34 125.482 1365.91 Q127.311 1369.45 130.922 1369.45 Q134.556 1369.45 136.362 1365.91 Q138.191 1362.34 138.191 1355.23 Q138.191 1348.1 136.362 1344.56 Q134.556 1341 130.922 1341 M130.922 1337.29 Q136.732 1337.29 139.788 1341.9 Q142.867 1346.48 142.867 1355.23 Q142.867 1363.96 139.788 1368.57 Q136.732 1373.15 130.922 1373.15 Q125.112 1373.15 122.033 1368.57 Q118.978 1363.96 118.978 1355.23 Q118.978 1346.48 122.033 1341.9 Q125.112 1337.29 130.922 1337.29 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M130.922 978.935 Q127.311 978.935 125.482 982.499 Q123.677 986.041 123.677 993.171 Q123.677 1000.28 125.482 1003.84 Q127.311 1007.38 130.922 1007.38 Q134.556 1007.38 136.362 1003.84 Q138.191 1000.28 138.191 993.171 Q138.191 986.041 136.362 982.499 Q134.556 978.935 130.922 978.935 M130.922 975.231 Q136.732 975.231 139.788 979.837 Q142.867 984.421 142.867 993.171 Q142.867 1001.9 139.788 1006.5 Q136.732 1011.09 130.922 1011.09 Q125.112 1011.09 122.033 1006.5 Q118.978 1001.9 118.978 993.171 Q118.978 984.421 122.033 979.837 Q125.112 975.231 130.922 975.231 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M94.7882 644.417 L111.108 644.417 L111.108 648.352 L89.1632 648.352 L89.1632 644.417 Q91.8252 641.662 96.4085 637.033 Q101.015 632.38 102.196 631.037 Q104.441 628.514 105.321 626.778 Q106.223 625.019 106.223 623.329 Q106.223 620.574 104.279 618.838 Q102.358 617.102 99.2558 617.102 Q97.0567 617.102 94.603 617.866 Q92.1725 618.63 89.3947 620.181 L89.3947 615.459 Q92.2188 614.324 94.6724 613.746 Q97.1261 613.167 99.1632 613.167 Q104.534 613.167 107.728 615.852 Q110.922 618.537 110.922 623.028 Q110.922 625.158 110.112 627.079 Q109.325 628.977 107.219 631.57 Q106.64 632.241 103.538 635.459 Q100.436 638.653 94.7882 644.417 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M130.922 616.871 Q127.311 616.871 125.482 620.436 Q123.677 623.977 123.677 631.107 Q123.677 638.213 125.482 641.778 Q127.311 645.32 130.922 645.32 Q134.556 645.32 136.362 641.778 Q138.191 638.213 138.191 631.107 Q138.191 623.977 136.362 620.436 Q134.556 616.871 130.922 616.871 M130.922 613.167 Q136.732 613.167 139.788 617.774 Q142.867 622.357 142.867 631.107 Q142.867 639.834 139.788 644.44 Q136.732 649.023 130.922 649.023 Q125.112 649.023 122.033 644.44 Q118.978 639.834 118.978 631.107 Q118.978 622.357 122.033 617.774 Q125.112 613.167 130.922 613.167 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M103.608 255.802 L91.8021 274.251 L103.608 274.251 L103.608 255.802 M102.381 251.728 L108.26 251.728 L108.26 274.251 L113.191 274.251 L113.191 278.14 L108.26 278.14 L108.26 286.288 L103.608 286.288 L103.608 278.14 L88.0058 278.14 L88.0058 273.626 L102.381 251.728 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M130.922 254.807 Q127.311 254.807 125.482 258.372 Q123.677 261.913 123.677 269.043 Q123.677 276.149 125.482 279.714 Q127.311 283.256 130.922 283.256 Q134.556 283.256 136.362 279.714 Q138.191 276.149 138.191 269.043 Q138.191 261.913 136.362 258.372 Q134.556 254.807 130.922 254.807 M130.922 251.103 Q136.732 251.103 139.788 255.71 Q142.867 260.293 142.867 269.043 Q142.867 277.77 139.788 282.376 Q136.732 286.959 130.922 286.959 Q125.112 286.959 122.033 282.376 Q118.978 277.77 118.978 269.043 Q118.978 260.293 122.033 255.71 Q125.112 251.103 130.922 251.103 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><polyline clip-path="url(#clip712)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="240.392,87.9763 650.56,178.492 1060.73,359.524 1470.9,631.072 1881.06,993.136 2291.23,1445.72 "></polyline>
<path clip-path="url(#clip710)" d="M2010.47 198.898 L2280.29 198.898 L2280.29 95.2176 L2010.47 95.2176  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip710)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2010.47,198.898 2280.29,198.898 2280.29,95.2176 2010.47,95.2176 2010.47,198.898 "></polyline>
<polyline clip-path="url(#clip710)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2034.63,147.058 2179.55,147.058 "></polyline>
<path clip-path="url(#clip710)" d="M2217.55 166.745 Q2215.75 171.375 2214.03 172.787 Q2212.32 174.199 2209.45 174.199 L2206.05 174.199 L2206.05 170.634 L2208.55 170.634 Q2210.31 170.634 2211.28 169.8 Q2212.25 168.967 2213.43 165.865 L2214.19 163.921 L2203.71 138.412 L2208.22 138.412 L2216.32 158.689 L2224.43 138.412 L2228.94 138.412 L2217.55 166.745 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path><path clip-path="url(#clip710)" d="M2236.23 160.402 L2243.87 160.402 L2243.87 134.037 L2235.56 135.703 L2235.56 131.444 L2243.82 129.778 L2248.5 129.778 L2248.5 160.402 L2256.14 160.402 L2256.14 164.338 L2236.23 164.338 L2236.23 160.402 Z" fill="#000000" fill-rule="evenodd" fill-opacity="1"></path></svg>
</div>
</div>
<p><strong>Define kind of problem, the state space, the actions, the reward function, and the Bellman updating equation</strong></p>
<p>kind of problem: - discrete/finite state and actions space - infinite horizon - discrete dynamic programming problem (d.m.d.p.)</p>
<ul>
<li>state-space: asset age <span class="math inline">\(a\in[0,1,2,3,4,5]\)</span></li>
<li>actions: <span class="math inline">\(x(a)\)</span> keep/replace (<span class="math inline">\(\text{replace} in false/true\)</span> if a&lt;5)</li>
</ul>
<p>Bellman updating equation:</p>
<p><span class="math display">\[ V(a) ← p(a) + \delta \begin{cases} V(0) - c \   \text{if x(a)=true} \\ V(a+1) \text{if x(a)=false} \\ V(0)-c \text{if a=5}\end{cases}   \]</span></p>
<p><strong>Solve the problem using Value Function Iteration</strong></p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bellman_step</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Solve the problem using Policy Iteration. Compare with VFI.</strong></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>